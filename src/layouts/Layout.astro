---
import "../styles/global.css";
import ConsentBanner from "../components/ConsentBanner.astro";

interface Props {
	title: string;
	description?: string;
}

const { title, description = "Persoonlijke GNM-Begeleiding door Crystal." } =
	Astro.props;
---

<!DOCTYPE html>
<html lang="nl">
	<head>
		<script is:inline>
			document.documentElement.classList.add("js");
		</script>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />

		<!-- SEO & Open Graph Meta Tags -->
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:type" content="website" />
		<meta property="og:url" content={Astro.url} />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<link rel="canonical" href={Astro.url} />

		<!-- Preload critical self-hosted fonts -->
		<link
			rel="preload"
			href="/fonts/outfit-latin.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>
		<link
			rel="preload"
			href="/fonts/lato-400-latin.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>

		<title>{title}</title>

		<!-- Cal.com Embed Script -->
		<script is:inline>
			(function (C, A, L) {
				let p = function (a, ar) { a.q.push(ar); };
				let d = C.document;
				C.Cal = C.Cal || function () {
					let cal = C.Cal;
					let ar = arguments;
					if (!cal.loaded) {
						cal.ns = {};
						cal.q = cal.q || [];
						d.head.appendChild(d.createElement("script")).src = A;
						cal.loaded = true;
					}
					if (ar[0] === L) {
						const api = function () { p(api, arguments); };
						const namespace = ar[1];
						api.q = api.q || [];
						if (typeof namespace === "string") {
							cal.ns[namespace] = cal.ns[namespace] || api;
							p(cal.ns[namespace], ar);
							p(cal, ["initNamespace", namespace]);
						} else p(cal, ar);
						return;
					}
					p(cal, ar);
				};
			})(window, "https://app.cal.com/embed/embed.js", "init");
			Cal("init", { origin: "https://app.cal.com" });
			Cal("on", {
				action: "bookingSuccessful",
				callback: function () {
					window.dataLayer = window.dataLayer || [];
					window.dataLayer.push({
						event: "generate_lead",
						lead_source: "cal_booking",
					});
					window.location.href = "/germaanse-geneeskunde-begeleiding/bedankt/";
				},
			});
		</script>

		<!-- Google Consent Mode v2 defaults (MUST load before GTM) -->
		<script is:inline>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("consent", "default", {
				ad_storage: "denied",
				ad_user_data: "denied",
				ad_personalization: "denied",
				analytics_storage: "denied",
				wait_for_update: 500,
			});
			// Restore previous consent choice if still valid (6 months)
			// NOTE: Same validation logic exists in ConsentBanner.astro â€” keep both in sync
			(function () {
				try {
					var stored = localStorage.getItem("cookie_consent");
					if (stored) {
						var data = JSON.parse(stored);
						var sixMonths = 180 * 24 * 60 * 60 * 1000;
						if (
							data.timestamp &&
							Date.now() - data.timestamp < sixMonths
						) {
							if (data.choice === "granted") {
								gtag("consent", "update", {
									ad_storage: "granted",
									ad_user_data: "granted",
									ad_personalization: "granted",
									analytics_storage: "granted",
								});
							}
						} else {
							localStorage.removeItem("cookie_consent");
						}
					}
				} catch (e) {}
			})();
		</script>

		<!-- Google Tag Manager via Stape Custom Loader -->
		<script is:inline>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({
					"gtm.start": new Date().getTime(),
					event: "gtm.js",
				});
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s);
				j.async = true;
				j.src =
					"https://ss.crystalhelder.nl/bakhobnkjj.js?" + i;
				f.parentNode.insertBefore(j, f);
			})(
				window,
				document,
				"script",
				"dataLayer",
				"8y=Aw5WKTYiRSYtXCM4KT9fTRxXWUBTSQwFVwkZFxEbCQcCDwcKBx1GBQY%3D"
			);
		</script>
	</head>
	<body
		class="bg-[var(--color-brand-base)] text-[var(--color-brand-primary-text)] antialiased font-sans text-lg selection:bg-[var(--color-brand-accent)] selection:text-white"
	>
		<!-- Google Tag Manager (noscript) via Stape -->
		<noscript
			><iframe
				src="https://ss.crystalhelder.nl/ns.html?id=GTM-MG6HVKP7"
				height="0"
				width="0"
				style="display:none;visibility:hidden"></iframe>
		</noscript>
		<slot />
		<ConsentBanner />
	</body>
</html>
